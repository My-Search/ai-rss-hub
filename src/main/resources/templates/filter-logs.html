<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            } catch (e) {}
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>筛选日志 - AI RSS Hub</title>
    <style>
        html { background-color: #f8fafc; }
        html[data-theme="dark"] { background-color: #272727; color: #f1f5f9; }
        body { background-color: #f8fafc; margin: 0; }
        html[data-theme="dark"] body { background-color: #272727; color: #f1f5f9; }
    </style>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
    <style>
        .logs-page {
            background: #0f172a;
            min-height: 100vh;
            padding: 2rem;
        }

        .logs-page .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .logs-page .page-header {
            margin-bottom: 2rem;
        }

        .logs-page .page-header h1 {
            color: #e2e8f0;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .logs-page .page-header p {
            color: #94a3b8;
        }

        .logs-page .filter-bar {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .logs-page .filter-bar h2 {
            color: #e2e8f0;
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }

        .logs-page .filter-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .logs-page .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .logs-page .filter-group.filter-result {
            flex: 0 0 120px;
            min-width: 120px;
        }

        .logs-page .filter-group.filter-source {
            flex: 0 0 180px;
            min-width: 180px;
        }

        .logs-page .filter-group.filter-keyword {
            flex: 2;
            min-width: 200px;
        }

        .logs-page .filter-group label {
            display: block;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .logs-page .filter-group select,
        .logs-page .filter-group input {
            width: 100%;
            padding: 0.75rem;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 4px;
            color: #e2e8f0;
            font-size: 0.875rem;
        }

        .logs-page .filter-group select:focus,
        .logs-page .filter-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .logs-page .filter-group select option {
            background: #0f172a;
            color: #e2e8f0;
        }

        .logs-page .btn-filter {
            background: #6366f1;
            color: #ffffff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .logs-page .btn-filter:hover {
            background: #4f46e5;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .logs-page .logs-container {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: hidden;
        }

        .logs-page .logs-header {
            background: #1e293b;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logs-page .logs-header h2 {
            color: #e2e8f0;
            font-size: 1.25rem;
            margin: 0;
        }

        .logs-page .logs-stats {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .logs-page .logs-table {
            width: 100%;
            border-collapse: collapse;
        }

        .logs-page .logs-body {
            overflow-x: auto;
        }

        .logs-page .logs-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .logs-page .logs-table {
            min-width: 800px;
        }

        .logs-page .logs-table th {
            background: #334155;
            color: #e2e8f0;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 1px solid #475569;
        }

        .logs-page .logs-table td {
            padding: 1rem;
            border-bottom: 1px solid #334155;
            color: #cbd5e1;
            font-size: 0.875rem;
        }

        .logs-page .logs-table tr:hover {
            background: #334155;
        }

        .logs-page .logs-table .log-title {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .logs-page .logs-table .log-title a {
            color: #818cf8;
            text-decoration: none;
        }

        .logs-page .logs-table .log-title a:hover {
            text-decoration: underline;
        }

        .logs-page .logs-table .log-source {
            color: #a78bfa;
        }

        .logs-page .logs-table .log-time {
            color: #94a3b8;
            font-family: monospace;
        }

        .logs-page .badge-passed {
            background: #10b981;
            color: #ffffff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .logs-page .badge-rejected {
            background: #ef4444;
            color: #ffffff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .logs-page .log-reason {
            color: #cbd5e1;
            font-size: 0.8125rem;
        }

        .logs-page .logs-table .log-raw-response {
            font-family: monospace;
            font-size: 0.75rem;
            color: #64748b;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .logs-page .logs-table .log-result {
            min-width: 80px;
            white-space: nowrap;
        }

        .logs-page .logs-table .log-reason {
            min-width: 150px;
        }

        .logs-page .pagination {
            background: #1e293b;
            padding: 1rem 1.5rem;
            border-top: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logs-page .pagination-info {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .logs-page .pagination-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .logs-page .pagination .btn {
            background: #0f172a;
            color: #cbd5e1;
            border: 1px solid #475569;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logs-page .pagination .btn:hover:not([disabled]) {
            background: #6366f1;
            color: #ffffff;
            border-color: #6366f1;
        }

        .logs-page .pagination .btn[disabled] {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .logs-page .pagination .btn-primary {
            background: #6366f1;
            color: #ffffff;
            border-color: #6366f1;
        }

        .logs-page .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }

        .logs-page .empty-state p {
            font-size: 1.125rem;
        }

        /* Skeleton loading styles - Shimmer effect */
        .logs-page .skeleton-row {
            background: linear-gradient(
                90deg,
                #1e293b 25%,
                #334155 50%,
                #1e293b 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .logs-page .skeleton-cell {
            background: #334155;
            border-radius: 4px;
            height: 16px;
            margin: 8px 0;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .logs-page .skeleton-cell.short {
            width: 60%;
        }

        .logs-page .skeleton-cell.medium {
            width: 80%;
        }

        .logs-page .skeleton-cell.long {
            width: 95%;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }

        /* Loading indicator styles */
        .logs-page .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            gap: 0.75rem;
        }

        .logs-page .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #334155;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .logs-page .loading-text {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status messages */
        .logs-page .status-message {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .logs-page .status-message.complete {
            color: #10b981;
        }

        .logs-page .status-message.error {
            color: #ef4444;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .logs-page .status-message.error:hover {
            opacity: 0.8;
        }

        .logs-page .status-message svg {
            width: 20px;
            height: 20px;
        }

        /* New row fade-in animation */
        .logs-page .logs-table tr.new-row {
            animation: fadeInRow 0.4s ease-out;
        }

        @keyframes fadeInRow {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sentinel element for intersection observer */
        .logs-page .scroll-sentinel {
            height: 20px;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .logs-page {
                padding: 1rem;
            }

            .logs-page .filter-row {
                flex-direction: column;
            }

            .logs-page .filter-group.filter-result,
            .logs-page .filter-group.filter-source,
            .logs-page .filter-group.filter-keyword {
                flex: 1;
                min-width: auto;
            }

            .logs-page .logs-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .logs-page .logs-table {
                min-width: 800px;
                font-size: 0.75rem;
            }

            .logs-page .logs-table th,
            .logs-page .logs-table td {
                padding: 0.5rem;
            }

            .logs-page .logs-table .log-result {
                min-width: 60px;
            }

            .logs-page .logs-table .log-reason {
            min-width: 100px;
        }

        .logs-page .loading-indicator {
            padding: 1.5rem;
        }

        .logs-page .loading-spinner {
            width: 28px;
            height: 28px;
        }

        /* 查看收藏按钮 */
        .btn-favorites {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            margin-left: auto;
        }

        .btn-favorites:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-favorites svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .page-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-header-flex .header-content {
            flex: 1;
        }

        .page-header-flex .header-content h1 {
            margin: 0 0 0.5rem 0;
        }

        .page-header-flex .header-content p {
            margin: 0;
            color: #94a3b8;
        }
    }
    </style>
</head>
<body>
    <div th:replace="fragments/header :: header"></div>

    <div class="logs-page">
        <div class="container">
            <div class="page-header page-header-flex">
                <div class="header-content">
                    <h1>筛选日志</h1>
                    <p>查看所有RSS消息的AI筛选记录</p>
                </div>
            </div>
            
            <div class="filter-bar">
                <h2>筛选条件</h2>
                <form th:action="@{/filter-logs}" method="get" class="filter-row">
                    <div class="filter-group filter-result">
                        <label>筛选结果</label>
                        <select name="filtered">
                            <option value="">全部</option>
                            <option value="true" th:selected="${filtered == 'true'}">通过</option>
                            <option value="false" th:selected="${filtered == 'false'}">未通过</option>
                        </select>
                    </div>
                    <div class="filter-group filter-source">
                        <label>RSS源</label>
                        <select name="source">
                            <option value="">全部</option>
                            <option th:each="source : ${sources}"
                                    th:value="${source}"
                                    th:text="${source}"
                                    th:selected="${source == currentSource}"></option>
                        </select>
                    </div>
                    <div class="filter-group filter-keyword">
                        <label>关键词搜索</label>
                        <input type="text" name="keyword" th:value="${keyword}" placeholder="搜索标题、原因或AI响应...">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn-filter">查询</button>
                    </div>
                </form>
            </div>
            
            <div class="logs-container">
                <div class="logs-header">
                    <h2>日志列表</h2>
                    <div class="logs-stats">
                        共 <span th:text="${totalLogs}">0</span> 条记录
                    </div>
                </div>
                
                <div class="logs-body">
                    <div class="logs-table-wrapper">
                        <table class="logs-table" th:if="${!#lists.isEmpty(logs)}">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>RSS源</th>
                                    <th>标题</th>
                                    <th class="log-result">结果</th>
                                    <th class="log-reason">原因</th>
                                    <th>AI响应</th>
                                </tr>
                            </thead>
                            <tbody id="logs-tbody">
                                <tr th:each="log : ${logs}">
                                    <td class="log-time" th:text="${#temporals.format(log.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                                    <td class="log-source" th:text="${log.sourceName}"></td>
                                    <td class="log-title">
                                        <a th:if="${log.link != null}" th:href="${log.link}" target="_blank" th:text="${log.title}"></a>
                                        <span th:if="${log.link == null}" th:text="${log.title}"></span>
                                    </td>
                                    <td class="log-result">
                                        <span class="badge-passed" th:if="${log.aiFiltered}">通过</span>
                                        <span class="badge-rejected" th:if="${!log.aiFiltered}">未通过</span>
                                    </td>
                                    <td class="log-reason" th:text="${log.aiReason}"></td>
                                    <td class="log-raw-response" th:text="${log.aiRawResponse}" th:title="${log.aiRawResponse}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div th:if="${#lists.isEmpty(logs)}" class="empty-state" id="empty-state">
                        <p>暂无筛选日志</p>
                    </div>

                    <!-- Skeleton loading (shown during initial load) -->
                    <div id="skeleton-loader" class="logs-table-wrapper" style="display: none;">
                        <table class="logs-table">
                            <tbody>
                                <tr class="skeleton-row">
                                    <td><div class="skeleton-cell short"></div></td>
                                    <td><div class="skeleton-cell medium"></div></td>
                                    <td><div class="skeleton-cell long"></div></td>
                                    <td><div class="skeleton-cell short"></div></td>
                                    <td><div class="skeleton-cell medium"></div></td>
                                    <td><div class="skeleton-cell long"></div></td>
                                </tr>
                                <tr class="skeleton-row">
                                    <td><div class="skeleton-cell short"></div></td>
                                    <td><div class="skeleton-cell medium"></div></td>
                                    <td><div class="skeleton-cell long"></div></td>
                                    <td><div class="skeleton-cell short"></div></td>
                                    <td><div class="skeleton-cell medium"></div></td>
                                    <td><div class="skeleton-cell long"></div></td>
                                </tr>
                                <tr class="skeleton-row">
                                    <td><div class="skeleton-cell short"></div></td>
                                    <td><div class="skeleton-cell medium"></div></td>
                                    <td><div class="skeleton-cell long"></div></td>
                                    <td><div class="skeleton-cell short"></div></td>
                                    <td><div class="skeleton-cell medium"></div></td>
                                    <td><div class="skeleton-cell long"></div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Loading indicator (shown when loading more) -->
                    <div id="loading-indicator" class="loading-indicator" style="display: none;">
                        <div class="loading-spinner"></div>
                        <span class="loading-text">加载中...</span>
                    </div>

                    <!-- All loaded message -->
                    <div id="complete-message" class="status-message complete" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <span>已加载全部记录</span>
                    </div>

                    <!-- Error message with retry -->
                    <div id="error-message" class="status-message error" style="display: none;" onclick="infiniteScroll.retry()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <span>加载失败，点击重试</span>
                    </div>

                    <!-- Scroll sentinel for intersection observer -->
                    <div id="scroll-sentinel" class="scroll-sentinel"></div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        /**
         * Infinite Scroll Manager - Law of Atomic Predictability
         * Pure state management with predictable transitions
         */
        class InfiniteScrollManager {
            constructor() {
                // State - all mutations go through setState()
                this.state = {
                    currentPage: /*[[${currentPage}]]*/ 1,
                    isLoading: false,
                    hasMore: /*[[${currentPage < totalPages}]]*/ true,
                    totalPages: /*[[${totalPages}]]*/ 1,
                    pageSize: /*[[${pageSize}]]*/ 20,
                    filters: {
                        filtered: /*[[${filtered}]]*/ '',
                        source: /*[[${currentSource}]]*/ '',
                        keyword: /*[[${keyword}]]*/ ''
                    }
                };

                // Race condition protection - request versioning
                this.requestId = 0;

                // DOM elements
                this.elements = {
                    tbody: document.querySelector('#logs-tbody'),
                    sentinel: document.getElementById('scroll-sentinel'),
                    skeleton: document.getElementById('skeleton-loader'),
                    loading: document.getElementById('loading-indicator'),
                    complete: document.getElementById('complete-message'),
                    error: document.getElementById('error-message'),
                    empty: document.getElementById('empty-state'),
                    filterForm: document.querySelector('.filter-row'),
                    filteredSelect: document.querySelector('select[name="filtered"]'),
                    sourceSelect: document.querySelector('select[name="source"]'),
                    keywordInput: document.querySelector('input[name="keyword"]')
                };

                // Initialize
                this.init();
            }

            /**
             * Initialize the infinite scroll - Law of Early Exit
             */
            init() {
                if (!this.elements.sentinel) {
                    console.error('Scroll sentinel not found');
                    return;
                }

                this.setupIntersectionObserver();
                this.setupFilterListeners();
                this.updateEmptyState();
            }

            /**
             * Setup IntersectionObserver for scroll detection
             */
            setupIntersectionObserver() {
                const options = {
                    root: null,
                    rootMargin: '100px',
                    threshold: 0.1
                };

                this.observer = new IntersectionObserver((entries) => {
                    const entry = entries[0];
                    if (entry.isIntersecting && !this.state.isLoading && this.state.hasMore) {
                        this.loadMore();
                    }
                }, options);

                this.observer.observe(this.elements.sentinel);
            }

            /**
             * Setup filter change listeners
             */
            setupFilterListeners() {
                if (!this.elements.filteredSelect || !this.elements.sourceSelect) return;

                const handleFilterChange = () => {
                    this.resetAndReload();
                };

                this.elements.filteredSelect.addEventListener('change', handleFilterChange);
                this.elements.sourceSelect.addEventListener('change', handleFilterChange);

                // Keyword input - trigger search on Enter key
                if (this.elements.keywordInput) {
                    this.elements.keywordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.resetAndReload();
                        }
                    });
                }

                // Prevent form submission (we handle it via JS)
                if (this.elements.filterForm) {
                    this.elements.filterForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.resetAndReload();
                    });
                }
            }

            /**
             * Update visibility of empty state - Law of Atomic Predictability
             */
            updateEmptyState() {
                const hasRows = this.elements.tbody && this.elements.tbody.children.length > 0;
                if (this.elements.empty) {
                    this.elements.empty.style.display = hasRows ? 'none' : 'block';
                }
            }

            /**
             * Show skeleton loading - for initial load
             */
            showSkeleton() {
                if (this.elements.skeleton) {
                    this.elements.skeleton.style.display = 'block';
                }
                if (this.elements.empty) {
                    this.elements.empty.style.display = 'none';
                }
            }

            /**
             * Hide skeleton loading
             */
            hideSkeleton() {
                if (this.elements.skeleton) {
                    this.elements.skeleton.style.display = 'none';
                }
            }

            /**
             * Show loading indicator - for subsequent loads
             */
            showLoading() {
                if (this.elements.loading) {
                    this.elements.loading.style.display = 'flex';
                }
            }

            /**
             * Hide loading indicator
             */
            hideLoading() {
                if (this.elements.loading) {
                    this.elements.loading.style.display = 'none';
                }
            }

            /**
             * Show complete message
             */
            showComplete() {
                if (this.elements.complete) {
                    this.elements.complete.style.display = 'flex';
                }
            }

            /**
             * Show error message
             */
            showError() {
                if (this.elements.error) {
                    this.elements.error.style.display = 'flex';
                }
            }

            /**
             * Hide error message
             */
            hideError() {
                if (this.elements.error) {
                    this.elements.error.style.display = 'none';
                }
            }

            /**
             * Build API URL with query parameters - Law of Intentional Naming
             */
            buildApiUrl(page) {
                const params = new URLSearchParams();
                params.append('page', page);
                params.append('pageSize', this.state.pageSize);

                if (this.state.filters.filtered) {
                    params.append('filtered', this.state.filters.filtered);
                }
                if (this.state.filters.source) {
                    params.append('source', this.state.filters.source);
                }
                if (this.state.filters.keyword) {
                    params.append('keyword', this.state.filters.keyword);
                }

                return `/api/filter-logs?${params.toString()}`;
            }

            /**
             * Load more data - Law of Fail Fast
             * Includes race condition protection via request versioning
             */
            async loadMore() {
                // Early exit if already loading or no more data
                if (this.state.isLoading || !this.state.hasMore) {
                    return;
                }

                // Increment request ID for race condition protection
                const currentRequestId = ++this.requestId;

                // Determine if this is initial load or subsequent load
                const isInitialLoad = this.state.currentPage === 1 &&
                    (!this.elements.tbody || this.elements.tbody.children.length === 0);

                // Set loading state
                this.setState({ isLoading: true });
                this.hideError();

                // Show appropriate loading UI
                if (isInitialLoad) {
                    this.showSkeleton();
                } else {
                    this.showLoading();
                }

                try {
                    const response = await fetch(this.buildApiUrl(this.state.currentPage));

                    // Race condition check: discard outdated responses
                    if (currentRequestId !== this.requestId) {
                        console.log('Request outdated, ignoring response');
                        return;
                    }

                    // Fail fast on non-ok response
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    // Race condition check: discard outdated responses
                    if (currentRequestId !== this.requestId) {
                        console.log('Request outdated, ignoring response');
                        return;
                    }

                    // Validate response structure - Fail Fast
                    if (!data || !Array.isArray(data.data)) {
                        throw new Error('Invalid response structure');
                    }

                    // Render the new rows
                    this.renderRows(data.data);

                    // Update state
                    this.setState({
                        currentPage: this.state.currentPage + 1,
                        hasMore: data.hasMore,
                        totalPages: data.totalPages,
                        isLoading: false
                    });

                    // Update UI state
                    this.hideSkeleton();
                    this.hideLoading();
                    this.updateEmptyState();

                    // Show complete message if no more data
                    if (!data.hasMore) {
                        this.showComplete();
                    }

                } catch (error) {
                    // Race condition check: only handle error for current request
                    if (currentRequestId !== this.requestId) {
                        return;
                    }

                    // Fail loud - log and show error UI
                    console.error('Failed to load filter logs:', error);
                    this.setState({ isLoading: false });
                    this.hideSkeleton();
                    this.hideLoading();
                    this.showError();
                }
            }

            /**
             * Render rows from data - Law of Atomic Predictability
             */
            renderRows(logs) {
                if (!this.elements.tbody || !Array.isArray(logs)) {
                    return;
                }

                logs.forEach((log, index) => {
                    const row = this.createRowElement(log, index);
                    this.elements.tbody.appendChild(row);
                });
            }

            /**
             * Create a table row element from log data - XSS-safe implementation.
             * Uses textContent instead of innerHTML to prevent XSS attacks.
             */
            createRowElement(log, index) {
                const tr = document.createElement('tr');
                tr.className = 'new-row';

                // Format date
                const formattedDate = this.formatDate(log.createdAt);

                // Time cell
                const timeCell = document.createElement('td');
                timeCell.className = 'log-time';
                timeCell.textContent = formattedDate;
                tr.appendChild(timeCell);

                // Source cell
                const sourceCell = document.createElement('td');
                sourceCell.className = 'log-source';
                sourceCell.textContent = log.sourceName || '';
                tr.appendChild(sourceCell);

                // Title cell - XSS-safe link handling
                const titleCell = document.createElement('td');
                titleCell.className = 'log-title';
                if (log.link) {
                    const link = document.createElement('a');
                    link.href = log.link;
                    link.target = '_blank';
                    link.textContent = log.title || ''; // Safe: textContent escapes HTML
                    titleCell.appendChild(link);
                } else {
                    titleCell.textContent = log.title || ''; // Safe: textContent escapes HTML
                }
                tr.appendChild(titleCell);

                // Result badge cell
                const resultCell = document.createElement('td');
                resultCell.className = 'log-result';
                const badge = document.createElement('span');
                if (log.aiFiltered) {
                    badge.className = 'badge-passed';
                    badge.textContent = '通过';
                } else {
                    badge.className = 'badge-rejected';
                    badge.textContent = '未通过';
                }
                resultCell.appendChild(badge);
                tr.appendChild(resultCell);

                // Reason cell
                const reasonCell = document.createElement('td');
                reasonCell.className = 'log-reason';
                reasonCell.textContent = log.aiReason || '';
                tr.appendChild(reasonCell);

                // Raw response cell
                const rawCell = document.createElement('td');
                rawCell.className = 'log-raw-response';
                rawCell.textContent = log.aiRawResponse || '';
                rawCell.title = log.aiRawResponse || '';
                tr.appendChild(rawCell);

                return tr;
            }

            /**
             * Format date string - Law of Atomic Predictability
             */
            formatDate(dateString) {
                if (!dateString) return '-';

                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString;

                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');

                    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                } catch (e) {
                    return dateString;
                }
            }

            /**
             * Escape HTML to prevent XSS - Law of Fail Fast
             */
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * Reset and reload data when filters change - Law of Atomic Predictability
             * Increments request ID to invalidate in-flight requests (race condition protection)
             */
            resetAndReload() {
                // Invalidate any in-flight requests by incrementing request ID
                this.requestId++;

                // Update filter state
                this.setState({
                    filters: {
                        filtered: this.elements.filteredSelect ? this.elements.filteredSelect.value : '',
                        source: this.elements.sourceSelect ? this.elements.sourceSelect.value : '',
                        keyword: this.elements.keywordInput ? this.elements.keywordInput.value : ''
                    },
                    currentPage: 1,
                    hasMore: true,
                    isLoading: false
                });

                // Clear existing rows
                if (this.elements.tbody) {
                    this.elements.tbody.innerHTML = '';
                }

                // Hide status messages
                if (this.elements.complete) {
                    this.elements.complete.style.display = 'none';
                }
                this.hideError();

                // Update URL for shareability (optional)
                this.updateUrl();

                // Load fresh data
                this.loadMore();
            }

            /**
             * Update browser URL to reflect current filters
             */
            updateUrl() {
                const params = new URLSearchParams();
                if (this.state.filters.filtered) {
                    params.append('filtered', this.state.filters.filtered);
                }
                if (this.state.filters.source) {
                    params.append('source', this.state.filters.source);
                }
                if (this.state.filters.keyword) {
                    params.append('keyword', this.state.filters.keyword);
                }

                const newUrl = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
                window.history.replaceState({}, '', newUrl);
            }

            /**
             * Retry loading after error - public method
             */
            retry() {
                this.hideError();
                this.loadMore();
            }

            /**
             * Update state immutably - Law of Atomic Predictability
             */
            setState(newState) {
                this.state = { ...this.state, ...newState };
            }

            /**
             * Cleanup method for resource management
             * Disconnects observer and clears references (useful for SPA navigation)
             */
            destroy() {
                if (this.observer) {
                    this.observer.disconnect();
                    this.observer = null;
                }
                // Increment request ID to invalidate any pending requests
                this.requestId++;
                // Clear references for garbage collection
                this.elements = {};
            }
        }

        // Initialize infinite scroll manager
        const infiniteScroll = new InfiniteScrollManager();
        /*]]>*/
    </script>
</body>
</html>
