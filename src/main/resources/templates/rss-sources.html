<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            } catch (e) {}
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS源管理 - AI RSS Hub</title>
    <style>
        html { background-color: #f8fafc; }
        html[data-theme="dark"] { background-color: #272727; color: #f1f5f9; }
        body { background-color: #f8fafc; margin: 0; }
        html[data-theme="dark"] body { background-color: #272727; color: #f1f5f9; }
    </style>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
</head>
<body class="rss-sources-page">
    <div th:replace="fragments/header :: header"></div>
    
    <div class="container">
        <div th:if="${message}" class="alert" th:classappend="${message.contains('成功') or message.contains('触发')} ? 'alert-success' : 'alert-danger'">
            <span th:text="${message}"></span>
        </div>
        
        <div class="page-header">
            <h1>RSS源管理</h1>
            <button class="btn btn-primary" onclick="showAddModal()">添加RSS源</button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <!-- 桌面端表格 -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>URL</th>
                                <th>刷新频率(分钟)</th>
                                <th>状态</th>
                                <th>最后抓取</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="source : ${sources}">
                                <td th:text="${source.name}"></td>
                                <td class="table-url"><a th:href="${source.url}" target="_blank" th:text="${source.url}"></a></td>
                                <td th:text="${source.refreshInterval}"></td>
                                <td>
                                    <span class="badge" th:classappend="${source.enabled} ? 'badge-success' : 'badge-secondary'"
                                          th:text="${source.enabled} ? '启用' : '禁用'"></span>
                                </td>
                                <td th:text="${source.lastFetchTime != null ? #temporals.format(source.lastFetchTime, 'yyyy-MM-dd HH:mm') : '未抓取'}"></td>
                                <td>
                                    <button class="btn btn-sm btn-primary"
                                            th:attr="data-id=${source.id},data-name=${source.name},data-url=${source.url},data-interval=${source.refreshInterval}"
                                            onclick="showEditModalFromData(this)">编辑</button>
                                    <form th:action="@{/rss-sources/{id}/toggle(id=${source.id})}" method="post" style="display:inline;">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn btn-sm" th:text="${source.enabled} ? '禁用' : '启用'"></button>
                                    </form>
                                    <form th:action="@{/rss-sources/{id}/fetch(id=${source.id})}" method="post" style="display:inline;" th:if="${source.enabled}">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn btn-sm btn-primary">立即抓取</button>
                                    </form>
                                    <form th:action="@{/rss-sources/{id}/delete(id=${source.id})}" method="post" style="display:inline;">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定删除?')">删除</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- 移动端卡片 -->
                <div class="rss-source-cards">
                    <div th:each="source : ${sources}" class="source-card">
                        <div class="source-card-header">
                            <span class="source-card-title" th:text="${source.name}"></span>
                            <span class="badge" th:classappend="${source.enabled} ? 'badge-success' : 'badge-secondary'"
                                  th:text="${source.enabled} ? '启用' : '禁用'"></span>
                        </div>
                        <div class="source-card-body">
                            <div class="source-card-row">
                                <span class="source-card-label">URL:</span>
                                <span class="source-card-value">
                                    <a th:href="${source.url}" target="_blank" th:text="${source.url}"></a>
                                </span>
                            </div>
                            <div class="source-card-row">
                                <span class="source-card-label">刷新频率:</span>
                                <span class="source-card-value" th:text="${source.refreshInterval} + ' 分钟'"></span>
                            </div>
                            <div class="source-card-row">
                                <span class="source-card-label">最后抓取:</span>
                                <span class="source-card-value" th:text="${source.lastFetchTime != null ? #temporals.format(source.lastFetchTime, 'yyyy-MM-dd HH:mm') : '未抓取'}"></span>
                            </div>
                        </div>
                        <div class="source-card-actions">
                            <button class="btn btn-sm btn-primary"
                                    th:attr="data-id=${source.id},data-name=${source.name},data-url=${source.url},data-interval=${source.refreshInterval}"
                                    onclick="showEditModalFromData(this)">编辑</button>
                            <form th:action="@{/rss-sources/{id}/toggle(id=${source.id})}" method="post" style="display:inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button type="submit" class="btn btn-sm" th:text="${source.enabled} ? '禁用' : '启用'"></button>
                            </form>
                            <form th:action="@{/rss-sources/{id}/fetch(id=${source.id})}" method="post" style="display:inline;" th:if="${source.enabled}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button type="submit" class="btn btn-sm btn-primary">抓取</button>
                            </form>
                            <form th:action="@{/rss-sources/{id}/delete(id=${source.id})}" method="post" style="display:inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定删除?')">删除</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div th:if="${#lists.isEmpty(sources)}" class="empty-state">
                    <p>暂无RSS源，点击上方按钮添加</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2>添加RSS源</h2>
            <form th:action="@{/rss-sources}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" name="name" placeholder="留空则自动从URL提取域名">
                </div>
                <div class="form-group">
                    <label>RSS URL</label>
                    <input type="url" name="url" required>
                </div>
                <div class="form-group">
                    <label>刷新频率(分钟)</label>
                    <input type="number" name="refreshInterval" th:value="${defaultRefreshInterval}" min="1" max="1440" required>
                    <small class="form-hint">留空则使用用户默认配置</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideAddModal()">取消</button>
                    <button type="submit" class="btn btn-primary">添加</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>编辑RSS源</h2>
            <form id="editForm" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" id="editId" name="id">
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" id="editName" name="name" placeholder="留空则自动从URL提取域名">
                </div>
                <div class="form-group">
                    <label>RSS URL</label>
                    <input type="url" id="editUrl" name="url" required>
                </div>
                <div class="form-group">
                    <label>刷新频率(分钟)</label>
                    <input type="number" id="editRefreshInterval" name="refreshInterval" min="1" max="1440" required>
                    <small class="form-hint">RSS源的抓取间隔</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideEditModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        function showAddModal() { document.getElementById('addModal').style.display = 'flex'; }
        function hideAddModal() { document.getElementById('addModal').style.display = 'none'; }
        
        function showEditModalFromData(btn) {
            var id = btn.getAttribute('data-id');
            var name = btn.getAttribute('data-name');
            var url = btn.getAttribute('data-url');
            var interval = btn.getAttribute('data-interval');
            showEditModal(id, name, url, interval);
        }

        function showEditModal(id, name, url, interval) {
            document.getElementById('editId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editUrl').value = url;
            document.getElementById('editRefreshInterval').value = interval || 60;
            document.getElementById('editForm').action = '/rss-sources/' + id + '/update';
            document.getElementById('editModal').style.display = 'flex';
        }
        
        function hideEditModal() { document.getElementById('editModal').style.display = 'none'; }
    </script>
</body>
</html>
