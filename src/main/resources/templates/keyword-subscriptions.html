<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            } catch (e) {}
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>关键词订阅管理 - AI RSS Hub</title>
    <style>
        html { background-color: #f8fafc; }
        html[data-theme="dark"] { background-color: #272727; color: #f1f5f9; }
        body { background-color: #f8fafc; margin: 0; }
        html[data-theme="dark"] body { background-color: #272727; color: #f1f5f9; }
    </style>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
</head>
<body>
    <div th:replace="fragments/header :: header"></div>

    <div class="container">
        <div th:if="${message}" class="alert" th:classappend="${message.contains('成功') or message.contains('触发')} ? 'alert-success' : 'alert-danger'">
            <span th:text="${message}"></span>
        </div>

        <div class="page-header">
            <h1>关键词订阅管理</h1>
            <button class="btn btn-primary" onclick="showAddModal()">添加关键词订阅</button>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="info-hint">
                    <p>提示：每条以空格分隔进行and条件，每当符合一条时就向用户发送邮件</p>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>编号</th>
                                <th>关键词</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="subscription, stat : ${keywordSubscriptions}">
                                <td th:text="${stat.index + 1}"></td>
                                <td th:text="${subscription.keywords}"></td>
                                <td>
                                    <span class="badge" th:classappend="${subscription.enabled} ? 'badge-success' : 'badge-secondary'"
                                          th:text="${subscription.enabled} ? '启用' : '禁用'"></span>
                                </td>
                                <td th:text="${subscription.createdAt != null ? #temporals.format(subscription.createdAt, 'yyyy-MM-dd HH:mm') : ''}"></td>
                                <td>
                                    <button class="btn btn-sm btn-primary"
                                            th:attr="data-id=${subscription.id},data-keywords=${subscription.keywords}"
                                            onclick="showEditModalFromData(this)" style="display: inline-flex; align-items: center; gap: 4px;">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 14px; height: 14px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                        编辑
                                    </button>
                                    <form th:action="@{/keyword-subscriptions/{id}/toggle(id=${subscription.id})}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm" style="display: inline-flex; align-items: center; gap: 4px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 14px; height: 14px;" th:if="${subscription.enabled}">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 14px; height: 14px;" th:if="${!subscription.enabled}">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span th:text="${subscription.enabled} ? '禁用' : '启用'"></span>
                                        </button>
                                    </form>
                                    <form th:action="@{/keyword-subscriptions/{id}/delete(id=${subscription.id})}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定删除?')" style="display: inline-flex; align-items: center; gap: 4px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 14px; height: 14px;">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                            删除
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${#lists.isEmpty(keywordSubscriptions)}" class="empty-state">
                    <p>暂无关键词订阅，点击上方按钮添加</p>
                </div>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2>添加关键词订阅</h2>
            <form th:action="@{/keyword-subscriptions}" method="post">
                <div class="form-group">
                    <label>关键词</label>
                    <input type="text" name="keywords" required placeholder="例如：glm 最新模型">
                </div>
                <div class="info-hint">
                    <p>提示：关键词之间用空格分隔，使用AND逻辑匹配。例如："glm 最新模型" 表示文章必须同时包含"glm"和"最新模型"</p>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideAddModal()">取消</button>
                    <button type="submit" class="btn btn-primary">添加</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>编辑关键词订阅</h2>
            <form id="editForm" method="post">
                <input type="hidden" id="editId" name="id">
                <div class="form-group">
                    <label>关键词</label>
                    <input type="text" id="editKeywords" name="keywords" required>
                </div>
                <div class="info-hint">
                    <p>提示：关键词之间用空格分隔，使用AND逻辑匹配。例如："glm 最新模型" 表示文章必须同时包含"glm"和"最新模型"</p>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideEditModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 14px; height: 14px; margin-right: 4px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        取消
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 14px; height: 14px; margin-right: 4px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showAddModal() { document.getElementById('addModal').style.display = 'flex'; }
        function hideAddModal() { document.getElementById('addModal').style.display = 'none'; }

        function showEditModalFromData(btn) {
            var id = btn.getAttribute('data-id');
            var keywords = btn.getAttribute('data-keywords');
            showEditModal(id, keywords);
        }

        function showEditModal(id, keywords) {
            document.getElementById('editId').value = id;
            document.getElementById('editKeywords').value = keywords;
            document.getElementById('editForm').action = '/keyword-subscriptions/' + id + '/update';
            document.getElementById('editModal').style.display = 'flex';
        }

        function hideEditModal() { document.getElementById('editModal').style.display = 'none'; }
    </script>
</body>
</html>
