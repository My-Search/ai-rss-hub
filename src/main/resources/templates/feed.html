<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            } catch (e) {}
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的RSS订阅 - AI RSS Hub</title>
    <style>
        html { background-color: #f8fafc; }
        html[data-theme="dark"] { background-color: #272727; color: #f1f5f9; }
        body { background-color: #f8fafc; margin: 0; }
        html[data-theme="dark"] body { background-color: #272727; color: #f1f5f9; }
    </style>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
</head>
<body>
    <div th:replace="fragments/header :: header"></div>
    
    <div class="container">
        <div class="page-header">
            <h1>我的RSS订阅</h1>
            <p>复制下方地址到你的RSS阅读器</p>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="form-group">
                    <label>RSS订阅地址</label>
                    <div class="rss-url-box">
                        <code th:text="${feedUrl}"></code>
                    </div>
                    <small>将此地址添加到你的RSS阅读器（如Feedly、Inoreader等）</small>
                </div>
                
                <button class="btn btn-primary" onclick="copyToClipboard()">复制地址</button>
            </div>
        </div>
        
        <div class="card" th:if="${user != null}">
            <div class="card-header">
                <h2>邮件订阅设置</h2>
            </div>
            <div class="card-body">
                <div id="emailConfigAlert" class="alert alert-warning" style="display: none; margin-bottom: 15px;">
                    系统未配置邮件服务，无法修改邮箱地址，请联系管理员。
                </div>
                <div class="form-group">
                    <label>邮箱地址</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="email" id="emailAddress" class="form-control" th:value="${user.email}" disabled>
                        <button type="button" id="changeEmailBtn" class="btn btn-secondary" style="display: none; white-space: nowrap;" onclick="showChangeEmailModal()">修改邮箱</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>每日摘要订阅</label>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="emailSubscription" th:checked="${user.emailSubscriptionEnabled}">
                        <label for="emailSubscription">启用每日自动发送最新RSS摘要</label>
                    </div>
                </div>
                <div class="form-group" id="digestTimeGroup">
                    <label>通知时间</label>
                    <input type="time" id="emailDigestTime" class="form-control" th:value="${user.emailDigestTime != null ? user.emailDigestTime : '19:00'}">
                    <small>设置后，系统将在每天指定时间自动发送当天最新的最多50条RSS摘要到您的邮箱。</small>
                </div>
                <div class="form-actions">
                    <button type="button" id="saveEmailSettingsBtn" class="btn btn-primary" onclick="updateEmailSettings()">保存设置</button>
                    <button type="button" class="btn btn-secondary" onclick="sendTestEmail()">发送测试邮件</button>
                </div>
            </div>
        </div>

        <!-- 修改邮箱弹窗 -->
        <div id="changeEmailModal" class="modal">
            <div class="modal-content">
                <h2>修改邮箱地址</h2>
                <div id="changeEmailStep1">
                    <div class="form-group">
                        <label>新邮箱地址</label>
                        <input type="email" id="newEmailInput" class="form-control" placeholder="请输入新邮箱地址">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="sendEmailChangeCode()">发送验证码</button>
                        <button type="button" class="btn" onclick="hideChangeEmailModal()">取消</button>
                    </div>
                </div>
                <div id="changeEmailStep2" style="display: none;">
                    <div class="form-group">
                        <label>验证码</label>
                        <input type="text" id="verificationCodeInput" class="form-control" placeholder="请输入收到的验证码">
                        <small>验证码已发送到您的新邮箱，请查收</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="hideChangeEmailModal()">取消</button>
                        <button type="button" class="btn btn-primary" onclick="verifyAndChangeEmail()">确认修改</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>关键词订阅</h2>
            </div>
            <div class="card-body">
                <div class="info-hint">
                    <p>提示：每条以空格分隔进行and条件，每当符合一条时就向用户发送邮件</p>
                </div>
                <button class="btn btn-primary mb-3 add-keyword-subscribe-btn" onclick="showAddModal()">添加关键词订阅</button>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>编号</th>
                                <th>关键词</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="subscription, stat : ${keywordSubscriptions}">
                                <td th:text="${stat.index + 1}"></td>
                                <td th:text="${subscription.keywords}"></td>
                                <td>
                                    <span class="badge" th:classappend="${subscription.enabled} ? 'badge-success' : 'badge-secondary'"
                                          th:text="${subscription.enabled} ? '启用' : '禁用'"></span>
                                </td>
                                <td th:text="${subscription.createdAt != null ? #temporals.format(subscription.createdAt, 'yyyy-MM-dd HH:mm') : ''}"></td>
                                <td>
                                    <button class="btn btn-sm btn-primary"
                                            th:attr="data-id=${subscription.id},data-keywords=${subscription.keywords}"
                                            onclick="showEditModalFromData(this)">编辑</button>
                                    <form th:action="@{/keyword-subscriptions/{id}/toggle(id=${subscription.id})}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm" th:text="${subscription.enabled} ? '禁用' : '启用'"></button>
                                    </form>
                                    <form th:action="@{/keyword-subscriptions/{id}/delete(id=${subscription.id})}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定删除?')">删除</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${#lists.isEmpty(keywordSubscriptions)}" class="empty-state">
                    <p>暂无关键词订阅，点击上方按钮添加</p>
                </div>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2>添加关键词订阅</h2>
            <form th:action="@{/keyword-subscriptions}" method="post">
                <div class="form-group">
                    <label>关键词</label>
                    <input type="text" name="keywords" required placeholder="例如：glm 最新模型">
                </div>
                <div class="info-hint">
                    <p>提示：关键词之间用空格分隔，使用AND逻辑匹配。例如："glm 最新模型" 表示文章必须同时包含"glm"和"最新模型"</p>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideAddModal()">取消</button>
                    <button type="submit" class="btn btn-primary">添加</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>编辑关键词订阅</h2>
            <form id="editForm" method="post">
                <input type="hidden" id="editId" name="id">
                <div class="form-group">
                    <label>关键词</label>
                    <input type="text" id="editKeywords" name="keywords" required>
                </div>
                <div class="info-hint">
                    <p>提示：关键词之间用空格分隔，使用AND逻辑匹配。例如："glm 最新模型" 表示文章必须同时包含"glm"和"最新模型"</p>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideEditModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let currentNewEmail = '';

        // 页面加载时检查邮件配置状态
        document.addEventListener('DOMContentLoaded', function() {
            checkEmailConfig();
        });

        function checkEmailConfig() {
            fetch('/email/config-status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const alertDiv = document.getElementById('emailConfigAlert');
                        const changeBtn = document.getElementById('changeEmailBtn');
                        if (data.configured) {
                            alertDiv.style.display = 'none';
                            changeBtn.style.display = 'inline-block';
                        } else {
                            alertDiv.style.display = 'block';
                            changeBtn.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('检查邮件配置失败:', error);
                });
        }

        function showChangeEmailModal() {
            document.getElementById('changeEmailModal').style.display = 'flex';
            document.getElementById('changeEmailStep1').style.display = 'block';
            document.getElementById('changeEmailStep2').style.display = 'none';
            document.getElementById('newEmailInput').value = '';
            document.getElementById('verificationCodeInput').value = '';
        }

        function hideChangeEmailModal() {
            document.getElementById('changeEmailModal').style.display = 'none';
        }

        function sendEmailChangeCode() {
            const newEmail = document.getElementById('newEmailInput').value.trim();
            if (!newEmail) {
                showToast('warning', '请输入新邮箱地址');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
                showToast('warning', '请输入有效的邮箱地址');
                return;
            }

            const formData = new FormData();
            formData.append('newEmail', newEmail);

            fetch('/email/change/send-code', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentNewEmail = newEmail;
                    document.getElementById('changeEmailStep1').style.display = 'none';
                    document.getElementById('changeEmailStep2').style.display = 'block';
                    showToast('success', data.message);
                } else {
                    showToast('error', data.message || '发送验证码失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', '发送验证码失败: ' + error.message);
            });
        }

        function verifyAndChangeEmail() {
            const verificationCode = document.getElementById('verificationCodeInput').value.trim();
            if (!verificationCode) {
                showToast('warning', '请输入验证码');
                return;
            }

            const formData = new FormData();
            formData.append('newEmail', currentNewEmail);
            formData.append('verificationCode', verificationCode);

            fetch('/email/change/verify', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                    hideChangeEmailModal();
                    window.location.reload();
                } else {
                    showToast('error', data.message || '验证失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', '验证失败: ' + error.message);
            });
        }

        function copyToClipboard() {
            const text = document.querySelector('.rss-url-box code').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('success', '已复制到剪贴板');
            });
        }

        function updateEmailSettings() {
            const saveBtn = document.getElementById('saveEmailSettingsBtn');
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.5';
            saveBtn.style.cursor = 'not-allowed';

            const enabled = document.getElementById('emailSubscription').checked;
            const digestTime = document.getElementById('emailDigestTime').value;

            const formData = new FormData();
            formData.append('enabled', enabled);

            fetch('/email/subscription', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || '订阅状态更新失败');
                }
                if (enabled && digestTime) {
                    const timeFormData = new FormData();
                    timeFormData.append('digestTime', digestTime);
                    return fetch('/email/digest-time', {
                        method: 'POST',
                        body: timeFormData
                    }).then(response => response.json());
                }
                return null;
            })
            .then(data => {
                if (data && !data.success) {
                    throw new Error(data.message || '摘要时间更新失败');
                }
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', '更新失败: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
            });
        }

        function sendTestEmail() {
            fetch('/email/test', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || '发送失败');
                }
                showToast('success', data.message);
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', '发送失败: ' + error.message);
            });
        }

        function showAddModal() { document.getElementById('addModal').style.display = 'flex'; }
        function hideAddModal() { document.getElementById('addModal').style.display = 'none'; }

        function showEditModalFromData(btn) {
            var id = btn.getAttribute('data-id');
            var keywords = btn.getAttribute('data-keywords');
            showEditModal(id, keywords);
        }

        function showEditModal(id, keywords) {
            document.getElementById('editId').value = id;
            document.getElementById('editKeywords').value = keywords;
            document.getElementById('editForm').action = '/keyword-subscriptions/' + id + '/update';
            document.getElementById('editModal').style.display = 'flex';
        }

        function hideEditModal() { document.getElementById('editModal').style.display = 'none'; }
    </script>
</body>
</html>
