# 实现用户自定义邮件通知时间功能

## 核心算法
- Cron每分钟执行，处理前一分钟需要发送的用户
- 分批查询（每批100个），按用户ID升序排序
- 避免整点并发压力，将发送任务分散到每分钟

## 实现步骤

### 1. 数据库层
- 在 `users` 表添加 `email_digest_time` 字段（TEXT，格式HH:mm，默认"19:00"）
- 创建索引 `idx_email_digest_time` 提升查询性能

### 2. 数据模型层
- [User.java](d:\data\users\zhuangjie\Downloads\ai-rss-hub\src\main\java\com\rssai\model\User.java) 添加 `emailDigestTime` 字段

### 3. 数据访问层
- [UserMapper.java](d:\data\users\zhuangjie\Downloads\ai-rss-hub\src\main\java\com\rssai\mapper\UserMapper.java) 添加方法：
  - `findUsersDueForDigestWithPagination(time, offset, limit)` - 分页查询
  - `updateEmailDigestTime(userId, time)` - 更新用户通知时间

### 4. 业务逻辑层
- [EmailScheduler.java](d:\data\users\zhuangjie\Downloads\ai-rss-hub\src\main\java\com\rssai\service\EmailScheduler.java) 修改：
  - Cron表达式改为每分钟执行：`0 * * * * ?`
  - 计算前一分钟时间
  - 分批查询用户（每批100个）
  - 异步发送邮件

### 5. 控制器层
- [EmailController.java](d:\data\users\zhuangjie\Downloads\ai-rss-hub\src\main\java\com\rssai\controller\EmailController.java) 添加：
  - 更新邮件通知时间的接口

### 6. 前端界面
- [feed.html](d:\data\users\zhuangjie\Downloads\ai-rss-hub\src\main\resources\templates\feed.html) 添加：
  - 时间选择器（`<input type="time">`）
  - 保存时间设置的JavaScript函数

### 7. 配置文件
- [application.yml](d:\data\users\zhuangjie\Downloads\ai-rss-hub\src\main\resources\application.yml) 更新cron表达式

## 关键特性
- ✅ 避免整点并发压力
- ✅ 分批处理防止内存溢出
- ✅ 按ID升序保证顺序性
- ✅ 索引优化提升查询性能
- ✅ 向后兼容（默认19:00）